{% extends "base.html" %}

{% block title %}Dashboard - HR Intelligence Platform{% endblock %}
{% block page_title %}Dashboard{% endblock %}

{% block content %}
<div class="dashboard-page">
    <!-- KPI Cards -->
    <section class="kpi-section">
        <div class="kpi-card">
            <div class="kpi-icon">üë•</div>
            <div class="kpi-content">
                <p class="kpi-label">Total Employees</p>
                <h3 class="kpi-value" id="kpi-employees">--</h3>
                <p class="kpi-change">+5 this month</p>
            </div>
        </div>

        <div class="kpi-card">
            <div class="kpi-icon">üìã</div>
            <div class="kpi-content">
                <p class="kpi-label">Open Leave Requests</p>
                <h3 class="kpi-value" id="kpi-leave-requests">--</h3>
                <p class="kpi-change">3 pending approval</p>
            </div>
        </div>

        <div class="kpi-card">
            <div class="kpi-icon">‚úÖ</div>
            <div class="kpi-content">
                <p class="kpi-label">Pending Approvals</p>
                <h3 class="kpi-value" id="kpi-approvals">--</h3>
                <p class="kpi-change">Action required</p>
            </div>
        </div>

        <div class="kpi-card">
            <div class="kpi-icon">üí¨</div>
            <div class="kpi-content">
                <p class="kpi-label">Agent Queries Today</p>
                <h3 class="kpi-value" id="kpi-queries">--</h3>
                <p class="kpi-change">Last 24 hours</p>
            </div>
        </div>
    </section>

    <!-- Charts Section -->
    <section class="charts-section">
        <div class="chart-container">
            <h3 class="chart-title">Department Headcount</h3>
            <canvas id="departmentChart" class="chart-canvas"></canvas>
        </div>

        <div class="chart-container">
            <h3 class="chart-title">Monthly Query Trend</h3>
            <canvas id="queryTrendChart" class="chart-canvas"></canvas>
        </div>
    </section>

    <!-- Quick Actions -->
    <section class="quick-actions-section">
        <h3 class="section-title">Quick Actions</h3>
        <div class="action-buttons">
            <button class="action-btn" onclick="navigateTo('/leave')">
                <span class="action-icon">üìù</span>
                <span class="action-text">New Leave Request</span>
            </button>
            <button class="action-btn" onclick="navigateTo('/chat')">
                <span class="action-icon">üí¨</span>
                <span class="action-text">Ask Agent</span>
            </button>
            <button class="action-btn" onclick="navigateTo('/documents')">
                <span class="action-icon">üìÑ</span>
                <span class="action-text">Generate Document</span>
            </button>
        </div>
    </section>

    <!-- Recent Activity (loaded dynamically from DB) -->
    <section class="activity-section">
        <h3 class="section-title">Recent Activity</h3>
        <div class="activity-feed" id="activity-feed">
            <div class="activity-item" id="activity-loading">
                <div class="activity-content" style="text-align:center; color:var(--text-secondary); padding:16px;">
                    Loading recent activity...
                </div>
            </div>
        </div>
    </section>

    <!-- Platform Status -->
    <section class="quick-actions-section" style="margin-top: 16px;">
        <h3 class="section-title">Feature Status</h3>
        <div class="action-buttons" style="gap: 12px; flex-wrap: wrap;">
            <div style="display:flex;align-items:center;gap:8px;padding:8px 14px;border-radius:8px;background:var(--bg-light, #F5F7FA);font-size:0.85rem;">
                <span style="color:#4CAF50;">‚óè</span> Leave Management ‚Äî <strong>Live</strong>
            </div>
            <div style="display:flex;align-items:center;gap:8px;padding:8px 14px;border-radius:8px;background:var(--bg-light, #F5F7FA);font-size:0.85rem;">
                <span style="color:#4CAF50;">‚óè</span> AI Chat & Policy Q&A ‚Äî <strong>Live</strong>
            </div>
            <div style="display:flex;align-items:center;gap:8px;padding:8px 14px;border-radius:8px;background:var(--bg-light, #F5F7FA);font-size:0.85rem;">
                <span style="color:#4CAF50;">‚óè</span> Document Generation ‚Äî <strong>Live</strong>
            </div>
            <div style="display:flex;align-items:center;gap:8px;padding:8px 14px;border-radius:8px;background:var(--bg-light, #F5F7FA);font-size:0.85rem;">
                <span style="color:#4CAF50;">‚óè</span> Benefits Enrollment ‚Äî <strong>Live</strong>
            </div>
            <div style="display:flex;align-items:center;gap:8px;padding:8px 14px;border-radius:8px;background:var(--bg-light, #F5F7FA);font-size:0.85rem;">
                <span style="color:#4CAF50;">‚óè</span> Analytics & Reporting ‚Äî <strong>Live</strong>
            </div>
            <div style="display:flex;align-items:center;gap:8px;padding:8px 14px;border-radius:8px;background:var(--bg-light, #F5F7FA);font-size:0.85rem;">
                <span style="color:#4CAF50;">‚óè</span> Workflow Approvals ‚Äî <strong>Live</strong>
            </div>
        </div>
    </section>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="/static/js/dashboard.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        fetchMetrics();
        loadRecentActivity();
        setInterval(fetchMetrics, 60000); // Refresh every 60 seconds
    });

    async function loadRecentActivity() {
        try {
            const response = await apiCall('/api/v2/activity/recent');
            const feed = document.getElementById('activity-feed');
            if (!feed) return;
            feed.innerHTML = '';

            const activities = (response && response.data) ? response.data : [];
            if (activities.length === 0) {
                feed.innerHTML = '<div class="activity-item"><div class="activity-content" style="text-align:center;color:var(--text-secondary);padding:16px;">No recent activity. Start chatting or submitting leave requests!</div></div>';
                return;
            }

            activities.forEach(function(a) {
                const item = document.createElement('div');
                item.className = 'activity-item';
                const timeStr = a.timestamp ? timeAgo(new Date(a.timestamp)) : '';
                item.innerHTML = '<div class="activity-icon">' + (a.icon || 'üìã') + '</div>' +
                    '<div class="activity-content">' +
                    '<p class="activity-title">' + escapeHtml(a.message) + '</p>' +
                    '<p class="activity-detail">' + escapeHtml(a.detail || '') + '</p>' +
                    '<p class="activity-time">' + timeStr + '</p>' +
                    '</div>';
                feed.appendChild(item);
            });
        } catch (e) {
            console.error('Error loading activity:', e);
        }
    }

    function timeAgo(date) {
        const now = new Date();
        const diff = Math.floor((now - date) / 1000);
        if (diff < 60) return 'just now';
        if (diff < 3600) return Math.floor(diff/60) + ' minutes ago';
        if (diff < 86400) return Math.floor(diff/3600) + ' hours ago';
        return Math.floor(diff/86400) + ' days ago';
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
</script>
{% endblock %}
