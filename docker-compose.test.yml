# Test compose — Runs app with PostgreSQL and Playwright tests
# Usage: docker-compose -f docker-compose.yml -f docker-compose.test.yml up

version: '3.8'

services:
  # ── PostgreSQL Database for Testing ─────────────────────
  postgres:
    image: postgres:15-alpine
    container_name: hr_platform_postgres_test
    environment:
      POSTGRES_USER: test
      POSTGRES_PASSWORD: test
      POSTGRES_DB: hr_test
    ports:
      - "5433:5432"
    volumes:
      - postgres_test_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U test -d hr_test"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - hr_test_network

  # ── Redis Cache for Testing ────────────────────────────
  redis:
    image: redis:7-alpine
    container_name: hr_platform_redis_test
    ports:
      - "6380:6379"
    command: redis-server --appendonly no --maxmemory 128mb
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - hr_test_network

  # ── Flask App for Testing ──────────────────────────────
  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: hr_platform_app_test
    environment:
      DATABASE_URL: postgresql://test:test@postgres:5432/hr_test
      REDIS_URL: redis://redis:6379/0
      JWT_SECRET: test-secret-key-change-in-production
      DEBUG: "false"
      LOG_LEVEL: INFO
      PORT: 5050
      WORKERS: 1
      TIMEOUT: 120
      OPENAI_API_KEY: test-key
      GOOGLE_API_KEY: test-key
      LANGCHAIN_TRACING_V2: "false"
      LANGCHAIN_API_KEY: ""
      LANGCHAIN_PROJECT: hr-multi-agent-test
    volumes:
      - app_logs_test:/app/logs
      - chroma_data_test:/app/data/chroma_db
      - ./data/policies:/app/data/policies:ro
      - ./data/documents:/app/data/documents
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - hr_test_network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5050/api/v2/health"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: on-failure

  # ── Nginx Reverse Proxy for Testing ────────────────────
  nginx:
    image: nginx:1.25-alpine
    container_name: hr_platform_nginx_test
    ports:
      - "8080:80"
    volumes:
      - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro
      - ./frontend/static:/app/frontend/static:ro
    depends_on:
      - app
    networks:
      - hr_test_network
    restart: on-failure

  # ── Playwright Test Runner ─────────────────────────────
  playwright:
    image: mcr.microsoft.com/playwright:v1.48.0-focal
    container_name: hr_platform_playwright_test
    working_dir: /app
    environment:
      APP_URL: http://nginx:80
      TEST_TIMEOUT: 15000
      HEADLESS: "true"
    volumes:
      - .:/app
      - /app/node_modules
    depends_on:
      app:
        condition: service_healthy
      nginx:
        condition: service_started
    networks:
      - hr_test_network
    command: |
      sh -c "
        npm ci &&
        npx playwright install chromium &&
        npx playwright test --timeout=15000 --reporter=line,html
      "

networks:
  hr_test_network:
    driver: bridge

volumes:
  postgres_test_data:
  app_logs_test:
  chroma_data_test:
